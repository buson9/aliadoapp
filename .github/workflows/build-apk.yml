name: Build Android AAB con API 35

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del código
      uses: actions/checkout@v4

    - name: Setup Java (JDK 17)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Instalar dependencias npm
      run: |
        npm install
        npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5

    - name: Inicializar Capacitor (si es necesario)
      run: |
        npx cap init AliadoApp com.aliadoapp.boristrabajos --web-dir=www
        npx cap add android
    - name: Show generated build.gradle
      run: |
        cat android/app/build.gradle

    - name: Configurar Android SDK 35
      uses: android-actions/setup-android@v3
      with:
        # instalar el paquete de la plataforma API 35
        packages: > 
          "platforms;android-35" "build-tools;35.0.0"
        accept-android-sdk-licenses: yes

    - name: Verificar SDK instalado
      run: sdkmanager --list

    - name: Ajustar compileSdk y targetSdk a 35
      run: |
        cd android
        sed -i 's/compileSdkVersion .*/compileSdkVersion 35/' app/build.gradle
        sed -i 's/targetSdkVersion .*/targetSdkVersion 35/' app/build.gradle
        # Si tienes también minSdkVersion y buildToolsVersion, puedes ajustarlas, por ejemplo:
        sed -i 's/buildToolsVersion .*/buildToolsVersion "35.0.0"/' app/build.gradle

    - name: Crear el keystore
      run: |
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > aliadoapp-key.keystore

    - name: Copiar web y sincronizar con Android
      run: |
        npx cap copy android
        npx cap sync android

    - name: Limpiar y construir AAB
      run: |
        cd android
        ./gradlew clean
        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file="../aliadoapp-key.keystore" \
          -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" \
          -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" \
          -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}" \
          --no-daemon

    - name: Subir AAB como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: aliadoapp-aab
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
